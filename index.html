<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RR Tools</title>
    <!-- Favicon desde GitHub -->
    <link rel="icon" type="image/png" href="https://github.com/DRG-GEM/rrtools/blob/main/rrtools.png?raw=true">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.11.338/pdf.min.js"></script>
    <script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
    <!-- CDN para la herramienta de quitar fondo (Carga estándar para máxima fiabilidad) -->
    <script src="https://cdn.jsdelivr.net/npm/@imgly/background-removal@latest/dist/browser.js"></script>
    <!-- CDN para codificar MP3 -->
    <script src="https://cdn.jsdelivr.net/npm/lamejs@1.2.1/lame.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .tool-card {
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }
        .tool-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .modal {
            display: none; 
            position: fixed; z-index: 1000; left: 0; top: 0;
            width: 100%; height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.5);
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background-color: #fefefe; margin: auto; padding: 20px;
            border: 1px solid #888; width: 80%; max-width: 500px;
            border-radius: 10px; text-align: center;
        }
        .modal-close {
            color: #aaa; float: right; font-size: 28px;
            font-weight: bold; cursor: pointer;
        }
        #signature-canvas {
            border: 2px dashed #ccc;
            border-radius: 0.5rem;
            cursor: crosshair;
            touch-action: none; /* Evita el scroll mientras se dibuja en móvil */
        }
        #pdf-pages-container {
            position: relative;
        }
        .pdf-page-canvas {
            border: 1px solid #e2e8f0;
            margin-bottom: 1rem;
        }
        #draggable-signature {
            position: absolute;
            cursor: move;
            border: 1px dashed #0ea5e9;
            z-index: 10;
        }
        #draggable-signature img {
            width: 100%;
            height: 100%;
            pointer-events: none;
        }
        #resize-handle {
            position: absolute;
            bottom: -5px;
            right: -5px;
            width: 10px;
            height: 10px;
            background-color: #0ea5e9;
            border: 1px solid white;
            border-radius: 50%;
            cursor: se-resize;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div id="app" class="container mx-auto p-4 md:p-8">

        <!-- Pantalla de Bienvenida -->
        <div id="welcome-screen" class="flex flex-col items-center justify-center min-h-[80vh] text-center">
            <img src="https://github.com/DRG-GEM/rrtools/blob/main/rrtools.png?raw=true" 
                 alt="Logo RR Tools" 
                 class="h-56 w-56 rounded-full object-contain bg-white p-4 shadow-xl mb-6">
            <h1 class="text-5xl md:text-6xl font-bold text-gray-900">RR Tools</h1>
            <p class="text-xl text-gray-600 mt-3">Tus utilidades digitales en un solo lugar.</p>
            <button onclick="enterApp()" class="mt-8 bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-8 rounded-full text-lg transition-transform transform hover:scale-105">
                Entrar
            </button>
        </div>

        <!-- Pantalla Principal de Herramientas (Oculta por defecto) -->
        <div id="main-content" class="hidden">
            <!-- Pantalla de selección de herramientas -->
            <div id="home-screen">
                <header class="text-center mb-10">
                    <h1 class="text-4xl md:text-5xl font-bold text-gray-900">RR Tools</h1>
                    <p class="text-lg text-gray-600 mt-2">Selecciona una herramienta</p>
                </header>

                <main id="tool-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6 md:gap-8">
                    <!-- PDF a JPG -->
                    <div onclick="showTool('pdf-to-jpg')" class="tool-card bg-white p-6 rounded-lg shadow-md cursor-pointer flex flex-col items-center text-center">
                        <svg class="w-16 h-16 mb-4 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                        <h2 class="text-xl font-semibold mb-2">PDF a JPG</h2>
                        <p class="text-gray-500">Convierte cada página de un PDF en una imagen.</p>
                    </div>
                    <!-- Unir PDF -->
                    <div onclick="showTool('merge-pdf')" class="tool-card bg-white p-6 rounded-lg shadow-md cursor-pointer flex flex-col items-center text-center">
                        <svg class="w-16 h-16 mb-4 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                        <h2 class="text-xl font-semibold mb-2">Unir PDF</h2>
                        <p class="text-gray-500">Combina varios archivos PDF en un único documento.</p>
                    </div>
                    <!-- Imagen a PDF -->
                    <div onclick="showTool('image-to-pdf')" class="tool-card bg-white p-6 rounded-lg shadow-md cursor-pointer flex flex-col items-center text-center">
                        <svg class="w-16 h-16 mb-4 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path></svg>
                        <h2 class="text-xl font-semibold mb-2">JPG/PNG a PDF</h2>
                        <p class="text-gray-500">Crea un PDF a partir de una o varias imágenes.</p>
                    </div>
                    <!-- Generador de Contraseñas -->
                    <div onclick="showTool('password-generator')" class="tool-card bg-white p-6 rounded-lg shadow-md cursor-pointer flex flex-col items-center text-center">
                        <svg class="w-16 h-16 mb-4 text-yellow-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path></svg>
                        <h2 class="text-xl font-semibold mb-2">Generador de Contraseñas</h2>
                        <p class="text-gray-500">Crea contraseñas robustas y seguras al instante.</p>
                    </div>
                    <!-- Generador de QR -->
                    <div onclick="showTool('qr-generator')" class="tool-card bg-white p-6 rounded-lg shadow-md cursor-pointer flex flex-col items-center text-center">
                        <svg class="w-16 h-16 mb-4 text-indigo-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v1m6 5h1m-6.465 6.465l.707.707M4 12H3m14.071 7.071l-.707-.707M5.635 5.636l-.707-.707M12 20v-1m-6.365-6.364l.707-.707M21 12h-1M6.Tus utilidades digitales en un solo lugar.929 18.364l.707.707"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 8v8H8V8h8z"></path></svg>
                        <h2 class="text-xl font-semibold mb-2">Generador de QR</h2>
                        <p class="text-gray-500">Convierte texto o enlaces en un código QR.</p>
                    </div>
                    <!-- Quitar Fondo de Imagen -->
                    <div onclick="showTool('remove-bg')" class="tool-card bg-white p-6 rounded-lg shadow-md cursor-pointer flex flex-col items-center text-center">
                        <svg class="w-16 h-16 mb-4 text-purple-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M9.75 3.104v5.714a2.25 2.25 0 01-.659 1.591L5 14.5M9.75 3.104c.251.023.501.05.75.082a.75.75 0 01.75.75v5.714a2.25 2.25 0 00.659 1.591L19.5 14.5M9.75 3.104C11.42 3.104 13.5 4.136 13.5 6c0 1.864-2.08 2.896-3.75 2.896S6 7.864 6 6c0-1.864 2.08-2.896 3.75-2.896zM12 12.75h9.75M12 12.75a2.25 2.25 0 01-2.25-2.25V6.75a2.25 2.25 0 012.25-2.25h.375M12 12.75c0-2.093.134-4.043.372-5.968m-9.444 6.252a2.25 2.25 0 00-2.25 2.25v2.25a2.25 2.25 0 002.25 2.25h15a2.25 2.25 0 002.25-2.25v-2.25a2.25 2.25 0 00-2.25-2.25H2.929z" />
                        </svg>
                        <h2 class="text-xl font-semibold mb-2">Quitar Fondo</h2>
                        <p class="text-gray-500">Sube una imagen y descarga la versión sin fondo.</p>
                    </div>
                    <!-- Comprimir Imagen -->
                    <div onclick="showTool('compress-image')" class="tool-card bg-white p-6 rounded-lg shadow-md cursor-pointer flex flex-col items-center text-center">
                        <svg class="w-16 h-16 mb-4 text-teal-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                          <path stroke-linecap="round" stroke-linejoin="round" d="M9 9V4.5M9 9H4.5M9 9L3.75 3.75M9 15v4.5M9 15H4.5M9 15l-5.25 5.25M15 9h4.5M15 9V4.5M15 9l5.25-5.25M15 15h4.5M15 15v4.5m0-4.5l5.25 5.25" />
                        </svg>
                        <h2 class="text-xl font-semibold mb-2">Comprimir Imagen</h2>
                        <p class="text-gray-500">Reduce el tamaño de tus imágenes JPG y PNG.</p>
                    </div>
                    <!-- Recortar Audio -->
                     <div onclick="showTool('trim-audio')" class="tool-card bg-white p-6 rounded-lg shadow-md cursor-pointer flex flex-col items-center text-center">
                        <svg class="w-16 h-16 mb-4 text-orange-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M9.53 16.122a3 3 0 00-5.78 1.128 2.25 2.25 0 01-2.43 2.43a4.5 4.5 0 008.636-2.122L9.53 16.122zm10.47-4.242a3 3 0 00-5.78-1.128 2.25 2.25 0 01-2.43-2.43a4.5 4.5 0 008.636 2.122L19.53 11.88z" />
                            <path stroke-linecap="round" stroke-linejoin="round" d="M12 18.75h.008v.008H12v-.008zm-2.25-2.25h.008v.008h-.008v-.008zm-2.25 2.25h.008v.008h-.008V18.75zm-2.25-2.25h.008v.008h-.008v-.008zm-2.25 2.25h.008v.008H7.5v-.008zm-2.25-2.25h.008v.008H5.25v-.008zM12 5.25h.008v.008H12V5.25zm2.25 2.25h.008v.008h-.008V7.5zm2.25 2.25h.008v.008h-.008V9.75zm2.25 2.25h.008v.008h-.008V12zm2.25 2.25h.008v.008h-.008v-.008z" />
                        </svg>
                        <h2 class="text-xl font-semibold mb-2">Recortar Audio</h2>
                        <p class="text-gray-500">Corta un fragmento de un archivo de audio.</p>
                    </div>
                     <!-- Firmar PDF -->
                    <div onclick="showTool('sign-pdf')" class="tool-card bg-white p-6 rounded-lg shadow-md cursor-pointer flex flex-col items-center text-center">
                        <svg class="w-16 h-16 mb-4 text-cyan-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                          <path stroke-linecap="round" stroke-linejoin="round" d="M16.862 4.487l1.687-1.688a1.875 1.875 0 112.652 2.652L10.582 16.07a4.5 4.5 0 01-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 011.13-1.897l8.932-8.931zm0 0L19.5 7.125M18 14v4.75A2.25 2.25 0 0115.75 21H5.25A2.25 2.25 0 013 18.75V8.25A2.25 2.25 0 015.25 6H10" />
                        </svg>
                        <h2 class="text-xl font-semibold mb-2">Firmar PDF</h2>
                        <p class="text-gray-500">Dibuja tu firma y añádela a un documento PDF.</p>
                    </div>
                </main>
            </div>

            <!-- Contenedor para las herramientas (inicialmente oculto) -->
            <div id="tool-container" class="hidden">
                <button onclick="showHomeScreen()" class="mb-8 bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg inline-flex items-center">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path></svg>
                    Volver al inicio
                </button>

                <!-- Herramienta: PDF a JPG -->
                <div id="pdf-to-jpg" class="tool-content hidden bg-white p-8 rounded-lg shadow-lg">
                    <h2 class="text-3xl font-bold mb-6 text-center">Convertir PDF a JPG</h2>
                    <div class="max-w-lg mx-auto text-center">
                        <label class="w-full inline-block cursor-pointer rounded-lg bg-red-500 px-4 py-3 text-center font-bold text-white hover:bg-red-600">
                            <span>Seleccionar Archivo PDF</span>
                            <input type="file" id="pdf-to-jpg-input" accept=".pdf" class="hidden"/>
                        </label>
                        <div id="pdf-to-jpg-filename" class="mt-4 text-sm text-gray-600"></div>
                        <div id="pdf-to-jpg-loader" class="hidden text-center mt-4">Procesando páginas...</div>
                        <div id="pdf-to-jpg-output" class="mt-6 grid grid-cols-2 md:grid-cols-3 gap-4"></div>
                    </div>
                </div>

                <!-- Herramienta: Unir PDF -->
                <div id="merge-pdf" class="tool-content hidden bg-white p-8 rounded-lg shadow-lg">
                    <h2 class="text-3xl font-bold mb-6 text-center">Unir Archivos PDF</h2>
                    <div class="max-w-lg mx-auto text-center">
                        <label class="w-full inline-block cursor-pointer rounded-lg bg-blue-500 px-4 py-3 text-center font-bold text-white hover:bg-blue-600">
                            <span>Seleccionar Archivos PDF</span>
                            <input type="file" id="merge-pdf-input" accept=".pdf" multiple class="hidden"/>
                        </label>
                        <div id="merge-pdf-list" class="mt-4 text-sm text-gray-600"></div>
                        <button id="merge-pdf-button" class="mt-6 w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-4 rounded-lg disabled:bg-blue-300" disabled>Unir y Descargar PDF</button>
                    </div>
                </div>

                <!-- Herramienta: Imagen a PDF -->
                <div id="image-to-pdf" class="tool-content hidden bg-white p-8 rounded-lg shadow-lg">
                    <h2 class="text-3xl font-bold mb-6 text-center">Convertir Imagen a PDF</h2>
                    <div class="max-w-lg mx-auto text-center">
                         <label class="w-full inline-block cursor-pointer rounded-lg bg-green-500 px-4 py-3 text-center font-bold text-white hover:bg-green-600">
                            <span>Seleccionar Imágenes (JPG/PNG)</span>
                            <input type="file" id="jpg-to-pdf-input" accept="image/jpeg,image/png" multiple class="hidden"/>
                        </label>
                        <div id="jpg-to-pdf-list" class="mt-4 text-sm text-gray-600"></div>
                        <button id="jpg-to-pdf-button" class="mt-6 w-full bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-4 rounded-lg disabled:bg-green-300" disabled>Convertir y Descargar PDF</button>
                    </div>
                </div>
                
                <!-- Herramienta: Generador de Contraseñas -->
                <div id="password-generator" class="tool-content hidden bg-white p-8 rounded-lg shadow-lg">
                    <h2 class="text-3xl font-bold mb-6 text-center">Generador de Contraseñas Seguras</h2>
                    <div class="max-w-md mx-auto">
                        <div class="relative mb-4 bg-gray-200 p-4 rounded-lg text-center">
                            <span id="password-output" class="text-2xl font-mono tracking-wider text-gray-800 break-all"></span>
                            <button id="copy-password-button" title="Copiar al portapapeles" class="absolute top-1/2 right-4 -translate-y-1/2 text-gray-500 hover:text-gray-800">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path></svg>
                            </button>
                        </div>
                        <div class="space-y-4">
                            <div>
                                <label for="pass-length" class="flex justify-between text-sm font-medium text-gray-700">Longitud: <span id="pass-length-value">16</span></label>
                                <input type="range" id="pass-length" min="8" max="32" value="16" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div class="flex items-center"><input type="checkbox" id="pass-uppercase" checked class="h-4 w-4 rounded border-gray-300 text-yellow-600 focus:ring-yellow-500"><label for="pass-uppercase" class="ml-2 block text-sm text-gray-900">Mayúsculas (A-Z)</label></div>
                                <div class="flex items-center"><input type="checkbox" id="pass-lowercase" checked class="h-4 w-4 rounded border-gray-300 text-yellow-600 focus:ring-yellow-500"><label for="pass-lowercase" class="ml-2 block text-sm text-gray-900">Minúsculas (a-z)</label></div>
                                <div class="flex items-center"><input type="checkbox" id="pass-numbers" checked class="h-4 w-4 rounded border-gray-300 text-yellow-600 focus:ring-yellow-500"><label for="pass-numbers" class="ml-2 block text-sm text-gray-900">Números (0-9)</label></div>
                                <div class="flex items-center"><input type="checkbox" id="pass-symbols" checked class="h-4 w-4 rounded border-gray-300 text-yellow-600 focus:ring-yellow-500"><label for="pass-symbols" class="ml-2 block text-sm text-gray-900">Símbolos (!@#$)</label></div>
                            </div>
                        </div>
                        <button id="generate-password-button" class="mt-8 w-full bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-3 px-4 rounded-lg">Generar Nueva Contraseña</button>
                    </div>
                </div>

                <!-- Herramienta: Generador de QR -->
                <div id="qr-generator" class="tool-content hidden bg-white p-8 rounded-lg shadow-lg">
                    <h2 class="text-3xl font-bold mb-6 text-center">Generador de Códigos QR</h2>
                    <div class="max-w-md mx-auto">
                        <label for="qr-input" class="block mb-2 text-sm font-medium text-gray-700">Introduce el texto o URL:</label>
                        <textarea id="qr-input" rows="4" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500" placeholder="https://ejemplo.com"></textarea>
                        <button id="generate-qr-button" class="mt-4 w-full bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg">Generar QR</button>
                        <div id="qr-output" class="mt-6 flex flex-col items-center">
                            <canvas id="qr-canvas" class="rounded-lg shadow-md"></canvas>
                            <a id="download-qr-link" class="hidden mt-4 bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg">Descargar QR</a>
                        </div>
                    </div>
                </div>

                <!-- Herramienta: Quitar Fondo de Imagen -->
<div id="remove-bg" class="tool-content hidden bg-white p-8 rounded-lg shadow-lg">
    <h2 class="text-3xl font-bold mb-6 text-center">Quitar Fondo de Imagen</h2>
    <div class="max-w-4xl mx-auto">
        <div class="bg-blue-50 border-l-4 border-blue-500 p-4 mb-6">
            <div class="flex">
                <div class="flex-shrink-0">
                    <svg class="h-5 w-5 text-blue-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" />
                    </svg>
                </div>
                <div class="ml-3">
                    <p class="text-sm text-blue-700">
                        <strong>Consejo:</strong> Esta herramienta funciona mejor con imágenes que tienen fondos uniformes y buen contraste entre el objeto y el fondo.
                    </p>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Panel de controles -->
            <div class="lg:col-span-1 space-y-6">
                <!-- Subir imagen -->
                <div id="remove-bg-upload-section">
                    <label class="block w-full cursor-pointer rounded-lg border-2 border-dashed border-gray-300 p-6 text-center hover:border-gray-400 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:ring-offset-2">
                        <svg class="mx-auto h-12 w-12 text-gray-400" stroke="currentColor" fill="none" viewBox="0 0 48 48">
                            <path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8m-12 4h.02" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                        </svg>
                        <span class="mt-2 block text-sm font-semibold text-gray-900">Seleccionar imagen</span>
                        <span class="mt-1 block text-xs text-gray-500">PNG, JPG hasta 5MB</span>
                        <input type="file" id="remove-bg-input" accept="image/png, image/jpeg" class="hidden"/>
                    </label>
                </div>

                <!-- Controles (se muestran después de subir imagen) -->
                <div id="remove-bg-controls" class="hidden space-y-6">
                    <!-- Selector de color -->
                    <div>
                        <h3 class="text-sm font-medium text-gray-900 mb-3">Color del fondo a eliminar</h3>
                        <div class="grid grid-cols-3 gap-2">
                            <button class="color-option bg-white border-2 border-purple-500 rounded-lg p-2" data-color="white">
                                <div class="h-8 rounded bg-white border"></div>
                                <span class="text-xs mt-1 block">Blanco</span>
                            </button>
                            <button class="color-option bg-gray-100 border-2 border-gray-300 rounded-lg p-2" data-color="black">
                                <div class="h-8 rounded bg-black"></div>
                                <span class="text-xs mt-1 block">Negro</span>
                            </button>
                            <button class="color-option bg-gray-100 border-2 border-gray-300 rounded-lg p-2" data-color="gray">
                                <div class="h-8 rounded bg-gray-500"></div>
                                <span class="text-xs mt-1 block">Gris</span>
                            </button>
                        </div>
                    </div>

                    <!-- Control de tolerancia -->
                    <div>
                        <div class="flex justify-between items-center mb-2">
                            <h3 class="text-sm font-medium text-gray-900">Precisión</h3>
                            <span id="tolerance-value" class="text-sm font-medium text-purple-600">30%</span>
                        </div>
                        <input type="range" id="tolerance" min="10" max="50" value="30" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-purple-600">
                        <p class="text-xs text-gray-500 mt-1">Ajusta para mejores resultados</p>
                    </div>

                    <!-- Botón de procesar -->
                    <button id="process-image-button" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-medium py-3 px-4 rounded-lg transition-colors duration-200">
                        Procesar Imagen
                    </button>
                </div>

                <!-- Loader -->
                <div id="remove-bg-process-loader" class="hidden text-center py-8">
                    <div class="inline-flex flex-col items-center">
                        <svg class="animate-spin h-8 w-8 text-purple-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        <p class="mt-3 text-sm font-medium text-gray-700">Procesando imagen...</p>
                    </div>
                </div>
            </div>

            <!-- Panel de resultados -->
            <div class="lg:col-span-2">
                <!-- Estado inicial -->
                <div id="remove-bg-placeholder" class="flex items-center justify-center h-64 bg-gray-50 rounded-lg border-2 border-dashed border-gray-300">
                    <div class="text-center">
                        <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                        </svg>
                        <p class="mt-2 text-sm text-gray-500">Selecciona una imagen para comenzar</p>
                    </div>
                </div>

                <!-- Resultados -->
                <div id="remove-bg-output" class="hidden">
                    <div class="bg-gray-50 rounded-lg p-4">
                        <h3 class="text-lg font-medium text-gray-900 mb-4 text-center">Resultado</h3>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                            <div>
                                <p class="text-sm font-medium text-gray-700 mb-2 text-center">Original</p>
                                <img id="remove-bg-original" class="w-full rounded-lg shadow-md max-h-64 object-contain mx-auto bg-white">
                            </div>
                            <div>
                                <p class="text-sm font-medium text-gray-700 mb-2 text-center">Sin fondo</p>
                                <canvas id="remove-bg-result" class="w-full rounded-lg shadow-md max-h-64 object-contain mx-auto bg-gray-100"></canvas>
                            </div>
                        </div>

                        <div class="flex flex-col sm:flex-row gap-3 justify-center">
                            <a id="remove-bg-download" class="inline-flex items-center justify-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-purple-600 hover:bg-purple-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-purple-500">
                                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
                                </svg>
                                Descargar imagen
                            </a>
                            <button onclick="resetRemoveBgTool()" class="inline-flex items-center justify-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-purple-500">
                                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                                </svg>
                                Procesar otra
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Error -->
                <div id="remove-bg-error" class="hidden mt-4 rounded-md bg-red-50 p-4">
                    <div class="flex">
                        <div class="flex-shrink-0">
                            <svg class="h-5 w-5 text-red-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" />
                            </svg>
                        </div>
                        <div class="ml-3">
                            <h3 class="text-sm font-medium text-red-800" id="remove-bg-error-message"></h3>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
                
                <!-- Herramienta: Comprimir Imagen -->
                <div id="compress-image" class="tool-content hidden bg-white p-8 rounded-lg shadow-lg">
                    <h2 class="text-3xl font-bold mb-6 text-center">Comprimir Imagen</h2>
                    <div class="max-w-xl mx-auto text-center">
                        <label class="w-full inline-block cursor-pointer rounded-lg bg-teal-500 px-4 py-3 text-center font-bold text-white hover:bg-teal-600">
                            <span>Seleccionar Imagen (JPG/PNG)</span>
                            <input type="file" id="compress-image-input" accept="image/jpeg, image/png" class="hidden"/>
                        </label>
                         <div id="compress-loader" class="hidden my-4 text-center">
                            <svg class="animate-spin h-8 w-8 text-teal-600 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                            <p class="mt-2 text-gray-600">Comprimiendo...</p>
                        </div>
                        <div id="compress-output" class="hidden mt-6">
                            <div class="mb-4">
                                <label for="compress-quality" class="flex justify-between text-sm font-medium text-gray-700">Calidad: <span id="compress-quality-value">75</span>%</label>
                                <input type="range" id="compress-quality" min="10" max="95" value="75" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 items-center">
                                <div>
                                    <h3 class="font-semibold mb-2">Original</h3>
                                    <img id="compress-original-img" class="rounded-lg shadow-md mx-auto max-h-64" src="">
                                    <p id="compress-original-size" class="text-sm mt-2 text-gray-500"></p>
                                </div>
                                <div>
                                    <h3 class="font-semibold mb-2">Comprimida</h3>
                                    <img id="compress-result-img" class="rounded-lg shadow-md mx-auto max-h-64" src="">
                                    <p id="compress-result-size" class="text-sm mt-2 text-green-600 font-semibold"></p>
                                </div>
                            </div>
                            <a id="compress-download-link" class="hidden mt-6 w-full sm:w-auto inline-block bg-teal-500 hover:bg-teal-600 text-white font-bold py-3 px-6 rounded-lg">Descargar Imagen Comprimida</a>
                        </div>
                    </div>
                </div>

                <!-- Herramienta: Recortar Audio -->
                <div id="trim-audio" class="tool-content hidden bg-white p-8 rounded-lg shadow-lg">
                    <h2 class="text-3xl font-bold mb-6 text-center">Recortar Audio</h2>
                    <div class="max-w-lg mx-auto text-center">
                        <label class="w-full inline-block cursor-pointer rounded-lg bg-orange-500 px-4 py-3 text-center font-bold text-white hover:bg-orange-600">
                            <span>Seleccionar Archivo de Audio</span>
                            <input type="file" id="trim-audio-input" accept="audio/*" class="hidden"/>
                        </label>
                        <div id="trim-audio-loader" class="hidden my-4 text-center">
                             <svg class="animate-spin h-8 w-8 text-orange-600 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                            <p id="trim-audio-loader-text" class="mt-2 text-gray-600">Procesando...</p>
                        </div>
                        <div id="trim-audio-controls" class="hidden mt-6 space-y-4">
                            <p class="text-sm text-gray-600">Audio Original:</p>
                            <audio id="audio-player" controls class="w-full"></audio>
                            <div class="grid grid-cols-2 gap-4 text-left">
                                <div>
                                    <label for="start-time" class="block text-sm font-medium text-gray-700">Inicio (segundos)</label>
                                    <input type="number" id="start-time" value="0" min="0" step="0.1" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-orange-500 focus:ring-orange-500 sm:text-sm p-2">
                                </div>
                                <div>
                                    <label for="end-time" class="block text-sm font-medium text-gray-700">Fin (segundos)</label>
                                    <input type="number" id="end-time" value="10" min="0" step="0.1" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-orange-500 focus:ring-orange-500 sm:text-sm p-2">
                                </div>
                            </div>
                            <button id="trim-audio-button" class="w-full bg-orange-500 hover:bg-orange-600 text-white font-bold py-3 px-4 rounded-lg">Recortar Audio</button>
                             <div id="trim-audio-output" class="hidden mt-6 space-y-4">
                                <p class="text-sm text-gray-600">Resultado:</p>
                                <audio id="trimmed-audio-player" controls class="w-full"></audio>
                                
                                <div class="flex items-center justify-center space-x-4 mt-4">
                                    <label class="text-sm font-medium text-gray-700">Formato:</label>
                                    <div class="flex items-center space-x-4">
                                        <label for="format-wav" class="flex items-center">
                                            <input type="radio" id="format-wav" name="audio-format" value="wav" checked class="h-4 w-4 text-orange-600 border-gray-300 focus:ring-orange-500">
                                            <span class="ml-2 text-sm text-gray-900">WAV</span>
                                        </label>
                                        <label for="format-mp3" class="flex items-center">
                                            <input type="radio" id="format-mp3" name="audio-format" value="mp3" class="h-4 w-4 text-orange-600 border-gray-300 focus:ring-orange-500">
                                            <span class="ml-2 text-sm text-gray-900">MP3</span>
                                        </label>
                                    </div>
                                </div>

                                <a id="download-trimmed-audio" class="w-full sm:w-auto inline-block bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-6 rounded-lg cursor-pointer">Descargar Audio Recortado</a>
                             </div>
                        </div>
                    </div>
                </div>

                <!-- Herramienta: Firmar PDF -->
                <div id="sign-pdf" class="tool-content hidden bg-white p-8 rounded-lg shadow-lg">
                    <h2 class="text-3xl font-bold mb-6 text-center">Firmar Documento PDF</h2>
                    <div class="max-w-4xl mx-auto text-center">
                        
                        <!-- Paso 1: Subir PDF -->
                        <div id="sign-step-1">
                            <label class="w-full inline-block cursor-pointer rounded-lg bg-cyan-500 px-4 py-3 text-center font-bold text-white hover:bg-cyan-600">
                                <span>1. Seleccionar Archivo PDF</span>
                                <input type="file" id="sign-pdf-input" accept=".pdf" class="hidden"/>
                            </label>
                            <p id="sign-pdf-filename" class="mt-4 text-sm text-gray-600"></p>
                        </div>

                        <!-- Paso 2: Dibujar Firma -->
                        <div id="sign-step-2" class="hidden mt-6">
                            <h3 class="text-xl font-semibold mb-2">2. Dibuja tu firma</h3>
                            <canvas id="signature-canvas" class="bg-white mx-auto w-full max-w-md"></canvas>
                            <div class="mt-4 flex flex-col sm:flex-row justify-center sm:space-x-4 space-y-2 sm:space-y-0">
                                <button id="clear-signature-button" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-lg">Limpiar</button>
                                <button id="save-signature-button" class="bg-cyan-500 hover:bg-cyan-600 text-white font-bold py-2 px-4 rounded-lg">Guardar Firma y Colocar</button>
                            </div>
                        </div>

                        <!-- Paso 3: Colocar Firma -->
                        <div id="sign-step-3" class="hidden mt-6">
                            <div class="flex flex-wrap justify-between items-center mb-4 gap-4">
                                <h3 class="text-lg font-semibold text-left">3. Mueve y ajusta la firma.</h3>
                                <div class="flex space-x-2">
                                    <button id="redraw-signature-button" class="bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-2 px-4 rounded-lg text-sm">Dibujar Nueva Firma</button>
                                    <button id="apply-signature-button" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg text-sm">Aplicar y Descargar</button>
                                </div>
                            </div>
                             <div id="sign-pdf-loader" class="hidden my-4 text-center">
                                <svg class="animate-spin h-8 w-8 text-cyan-600 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                </svg>
                                <p id="sign-pdf-loader-text" class="mt-2 text-gray-600">Procesando...</p>
                            </div>
                            <div id="pdf-pages-container" class="bg-gray-200 p-2 md:p-4 rounded-lg overflow-auto max-h-[60vh]"></div>
                        </div>

                    </div>
                </div>

            </div>
        </div>
    </div>

    <!-- Modal para mensajes -->
    <div id="message-modal" class="modal">
        <div class="modal-content">
            <span id="modal-close-button" class="modal-close">&times;</span>
            <p id="modal-message" class="text-lg"></p>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- NAVEGACIÓN ---
            const welcomeScreen = document.getElementById('welcome-screen');
            const mainContent = document.getElementById('main-content');
            const homeScreen = document.getElementById('home-screen');
            const toolContainer = document.getElementById('tool-container');
            const toolContents = document.querySelectorAll('.tool-content');

            window.enterApp = function() {
                welcomeScreen.classList.add('hidden');
                mainContent.classList.remove('hidden');
            }

            window.showTool = function(toolId) {
                homeScreen.classList.add('hidden');
                toolContainer.classList.remove('hidden');
                toolContents.forEach(tool => {
                    tool.classList.add('hidden');
                    if (tool.id === toolId) {
                        tool.classList.remove('hidden');
                    }
                });
                if (toolId === 'password-generator') {
                    generatePassword();
                }
                if (toolId === 'sign-pdf') {
                    const savedSignature = sessionStorage.getItem('rrtools_signature');
                    if (savedSignature) {
                        signatureDataUrl = savedSignature;
                    }
                }
                 if (toolId === 'remove-bg') {
                    initializeRemoveBgTool();
                }
            }

            window.showHomeScreen = function() {
                homeScreen.classList.remove('hidden');
                toolContainer.classList.add('hidden');
                resetSignPdfTool();
            }

            // --- MODAL DE MENSAJES ---
            const modal = document.getElementById('message-modal');
            const modalMessage = document.getElementById('modal-message');
            const modalCloseButton = document.getElementById('modal-close-button');

            function showMessage(message) {
                modalMessage.textContent = message;
                modal.style.display = "flex";
            }

            modalCloseButton.onclick = function() {
                modal.style.display = "none";
            }
            window.onclick = function(event) {
                if (event.target == modal) {
                    modal.style.display = "none";
                }
            }
            
            // --- LIBRERÍAS Y HERRAMIENTAS ---
            pdfjsLib.GlobalWorkerOptions.workerSrc = `https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.11.338/pdf.worker.min.js`;
            const { PDFDocument, rgb } = PDFLib;

            // --- HERRAMIENTA 1: PDF a JPG ---
            const pdfToJpgInput = document.getElementById('pdf-to-jpg-input');
            const pdfToJpgOutput = document.getElementById('pdf-to-jpg-output');
            const pdfToJpgLoader = document.getElementById('pdf-to-jpg-loader');
            const pdfToJpgFilename = document.getElementById('pdf-to-jpg-filename');
            
            pdfToJpgInput.addEventListener('change', async (event) => {
                const file = event.target.files[0];
                if (!file) {
                    pdfToJpgFilename.textContent = '';
                    return;
                }
                pdfToJpgFilename.textContent = `Archivo seleccionado: ${file.name}`;
                pdfToJpgOutput.innerHTML = '';
                pdfToJpgLoader.classList.remove('hidden');

                try {
                    const fileReader = new FileReader();
                    fileReader.onload = async (e) => {
                        const typedarray = new Uint8Array(e.target.result);
                        const pdf = await pdfjsLib.getDocument(typedarray).promise;

                        for (let i = 1; i <= pdf.numPages; i++) {
                            const page = await pdf.getPage(i);
                            const viewport = page.getViewport({ scale: 1.5 });
                            const canvas = document.createElement('canvas');
                            const context = canvas.getContext('2d');
                            canvas.height = viewport.height;
                            canvas.width = viewport.width;

                            await page.render({ canvasContext: context, viewport: viewport }).promise;
                            
                            const img = document.createElement('a');
                            img.href = canvas.toDataURL('image/jpeg');
                            img.download = `${file.name.replace('.pdf', '')}-pagina-${i}.jpg`;
                            img.innerHTML = `<img src="${img.href}" class="w-full h-auto rounded-lg shadow-md" alt="Página ${i}">`;
                            pdfToJpgOutput.appendChild(img);
                        }
                        pdfToJpgLoader.classList.add('hidden');
                    };
                    fileReader.readAsArrayBuffer(file);
                } catch (error) {
                    console.error('Error al procesar el PDF:', error);
                    showMessage('Error al procesar el PDF. Asegúrate de que es un archivo válido.');
                    pdfToJpgLoader.classList.add('hidden');
                }
            });

            // --- HERRAMIENTA 2: UNIR PDF ---
            const mergePdfInput = document.getElementById('merge-pdf-input');
            const mergePdfButton = document.getElementById('merge-pdf-button');
            const mergePdfList = document.getElementById('merge-pdf-list');

            mergePdfInput.addEventListener('change', () => {
                const files = mergePdfInput.files;
                if (files.length > 1) {
                    mergePdfButton.disabled = false;
                    let fileNames = Array.from(files).map(f => f.name).join(', ');
                    mergePdfList.textContent = `Archivos seleccionados (${files.length}): ${fileNames}`;
                } else {
                    mergePdfButton.disabled = true;
                    mergePdfList.textContent = files.length === 1 ? 'Por favor, selecciona al menos 2 archivos.' : 'Ningún archivo seleccionado.';
                }
            });

            mergePdfButton.addEventListener('click', async () => {
                mergePdfButton.disabled = true;
                mergePdfButton.textContent = 'Procesando...';
                try {
                    const mergedPdf = await PDFDocument.create();
                    for (const file of mergePdfInput.files) {
                        const arrayBuffer = await file.arrayBuffer();
                        const pdf = await PDFDocument.load(arrayBuffer);
                        const copiedPages = await mergedPdf.copyPages(pdf, pdf.getPageIndices());
                        copiedPages.forEach((page) => mergedPdf.addPage(page));
                    }
                    const pdfBytes = await mergedPdf.save();
                    const blob = new Blob([pdfBytes], { type: 'application/pdf' });
                    const link = document.createElement('a');
                    link.href = URL.createObjectURL(blob);
                    link.download = 'documento-unido.pdf';
                    link.click();
                    URL.revokeObjectURL(link.href);
                } catch (error) {
                    console.error('Error al unir los PDFs:', error);
                    showMessage('Hubo un error al unir los PDFs. Inténtalo de nuevo.');
                } finally {
                    mergePdfButton.disabled = false;
                    mergePdfButton.textContent = 'Unir y Descargar PDF';
                }
            });

            // --- HERRAMIENTA 3: IMAGEN a PDF ---
            const jpgToPdfInput = document.getElementById('jpg-to-pdf-input');
            const jpgToPdfButton = document.getElementById('jpg-to-pdf-button');
            const jpgToPdfList = document.getElementById('jpg-to-pdf-list');

            jpgToPdfInput.addEventListener('change', () => {
                const files = jpgToPdfInput.files;
                if (files.length > 0) {
                    jpgToPdfButton.disabled = false;
                    let fileNames = Array.from(files).map(f => f.name).join(', ');
                    jpgToPdfList.textContent = `Imágenes seleccionadas (${files.length}): ${fileNames}`;
                } else {
                    jpgToPdfButton.disabled = true;
                    jpgToPdfList.textContent = 'Ninguna imagen seleccionada.';
                }
            });

            jpgToPdfButton.addEventListener('click', async () => {
                jpgToPdfButton.disabled = true;
                jpgToPdfButton.textContent = 'Creando PDF...';
                try {
                    const pdfDoc = await PDFDocument.create();
                    for (const file of jpgToPdfInput.files) {
                         const arrayBuffer = await file.arrayBuffer();
                         let image;
                         if (file.type === 'image/jpeg') {
                            image = await pdfDoc.embedJpg(arrayBuffer);
                         } else if (file.type === 'image/png') {
                            image = await pdfDoc.embedPng(arrayBuffer);
                         } else {
                            showMessage(`Formato de imagen no soportado: ${file.name}. Usa JPG o PNG.`);
                            continue;
                         }
                        const page = pdfDoc.addPage([image.width, image.height]);
                        page.drawImage(image, {
                            x: 0,
                            y: 0,
                            width: image.width,
                            height: image.height,
                        });
                    }
                    const pdfBytes = await pdfDoc.save();
                    const blob = new Blob([pdfBytes], { type: 'application/pdf' });
                    const link = document.createElement('a');
                    link.href = URL.createObjectURL(blob);
                    link.download = 'convertido-desde-imagenes.pdf';
                    link.click();
                    URL.revokeObjectURL(link.href);
                } catch (error) {
                    console.error('Error al convertir imagen a PDF:', error);
                    showMessage('Hubo un error al crear el PDF. Asegúrate de que todas las imágenes son válidas.');
                } finally {
                    jpgToPdfButton.disabled = false;
                    jpgToPdfButton.textContent = 'Convertir y Descargar PDF';
                }
            });
            
            // --- HERRAMIENTA 4: GENERADOR DE CONTRASEÑAS ---
            const passwordOutput = document.getElementById('password-output');
            const passLength = document.getElementById('pass-length');
            const passLengthValue = document.getElementById('pass-length-value');
            const passUppercase = document.getElementById('pass-uppercase');
            const passLowercase = document.getElementById('pass-lowercase');
            const passNumbers = document.getElementById('pass-numbers');
            const passSymbols = document.getElementById('pass-symbols');
            const generatePasswordButton = document.getElementById('generate-password-button');
            const copyPasswordButton = document.getElementById('copy-password-button');

            const charSets = {
                uppercase: 'ABCDEFGHIJKLMNOPQRSTUVWXYZ',
                lowercase: 'abcdefghijklmnopqrstuvwxyz',
                numbers: '0123456789',
                symbols: '!@#$%^&*()_+-=[]{}|;:,.<>?'
            };

            window.generatePassword = function() {
                let charset = '';
                if (passUppercase.checked) charset += charSets.uppercase;
                if (passLowercase.checked) charset += charSets.lowercase;
                if (passNumbers.checked) charset += charSets.numbers;
                if (passSymbols.checked) charset += charSets.symbols;

                if (charset === '') {
                    showMessage('Por favor, selecciona al menos un tipo de carácter.');
                    passwordOutput.textContent = '...';
                    return;
                }

                let password = '';
                const length = passLength.value;
                for (let i = 0; i < length; i++) {
                    password += charset.charAt(Math.floor(Math.random() * charset.length));
                }
                passwordOutput.textContent = password;
            }
            
            passLength.addEventListener('input', (e) => {
                passLengthValue.textContent = e.target.value;
                generatePassword();
            });
            generatePasswordButton.addEventListener('click', generatePassword);
            [passUppercase, passLowercase, passNumbers, passSymbols].forEach(el => el.addEventListener('change', generatePassword));

            copyPasswordButton.addEventListener('click', () => {
                const password = passwordOutput.textContent;
                if (password && password !== '...') {
                    const textArea = document.createElement("textarea");
                    textArea.value = password;
                    document.body.appendChild(textArea);
                    textArea.focus();
                    textArea.select();
                    try {
                        document.execCommand('copy');
                        showMessage('¡Contraseña copiada!');
                    } catch (err) {
                        showMessage('No se pudo copiar la contraseña.');
                    }
                    document.body.removeChild(textArea);
                }
            });
            
            generatePassword();

            // --- HERRAMIENTA 5: GENERADOR DE QR ---
            const qrInput = document.getElementById('qr-input');
            const generateQrButton = document.getElementById('generate-qr-button');
            const qrCanvas = document.getElementById('qr-canvas');
            const downloadQrLink = document.getElementById('download-qr-link');

            function generateQR() {
                const text = qrInput.value;
                if (text.trim() === '') {
                    showMessage('Por favor, introduce texto o una URL para generar el QR.');
                    return;
                }
                QRCode.toCanvas(qrCanvas, text, { width: 256, errorCorrectionLevel: 'H' }, function (error) {
                    if (error) {
                        console.error(error);
                        showMessage('No se pudo generar el código QR.');
                    } else {
                        downloadQrLink.href = qrCanvas.toDataURL('image/png');
                        downloadQrLink.download = 'codigo-qr.png';
                        downloadQrLink.classList.remove('hidden');
                    }
                });
            }
            
            generateQrButton.addEventListener('click', generateQR);
            qrInput.addEventListener('keyup', (e) => {
                if (e.key === 'Enter') {
                    generateQR();
                }
            });
            
            // --- HERRAMIENTA 6: QUITAR FONDO DE IMAGEN (SOLUCIÓN LOCAL) ---
const removeBgInput = document.getElementById('remove-bg-input');
const removeBgUploadSection = document.getElementById('remove-bg-upload-section');
const removeBgControls = document.getElementById('remove-bg-controls');
const removeBgProcessLoader = document.getElementById('remove-bg-process-loader');
const removeBgOutput = document.getElementById('remove-bg-output');
const removeBgPlaceholder = document.getElementById('remove-bg-placeholder');
const removeBgOriginal = document.getElementById('remove-bg-original');
const removeBgResult = document.getElementById('remove-bg-result');
const removeBgDownload = document.getElementById('remove-bg-download');
const removeBgError = document.getElementById('remove-bg-error');
const removeBgErrorMessage = document.getElementById('remove-bg-error-message');
const toleranceSlider = document.getElementById('tolerance');
const toleranceValue = document.getElementById('tolerance-value');
const processImageButton = document.getElementById('process-image-button');

let currentImageFile = null;
let selectedBgColor = 'white';

// Mapeo de colores a valores RGB
const colorMap = {
    'white': { r: 255, g: 255, b: 255 },
    'black': { r: 0, g: 0, b: 0 },
    'gray': { r: 128, g: 128, b: 128 }
};

// Función para resetear la herramienta
window.resetRemoveBgTool = function() {
    removeBgInput.value = '';
    removeBgOutput.classList.add('hidden');
    removeBgControls.classList.add('hidden');
    removeBgProcessLoader.classList.add('hidden');
    removeBgError.classList.add('hidden');
    removeBgPlaceholder.classList.remove('hidden');
    removeBgUploadSection.classList.remove('hidden');
    currentImageFile = null;
    
    // Resetear selección de color
    document.querySelectorAll('.color-option').forEach(btn => {
        btn.classList.remove('border-purple-500');
        btn.classList.add('border-gray-300');
    });
    document.querySelector('.color-option[data-color="white"]').classList.add('border-purple-500');
    document.querySelector('.color-option[data-color="white"]').classList.remove('border-gray-300');
    selectedBgColor = 'white';
    
    // Resetear slider
    toleranceSlider.value = 30;
    toleranceValue.textContent = '30%';
};

// Configurar los botones de color
document.querySelectorAll('.color-option').forEach(button => {
    button.addEventListener('click', function() {
        // Remover selección anterior
        document.querySelectorAll('.color-option').forEach(btn => {
            btn.classList.remove('border-purple-500');
            btn.classList.add('border-gray-300');
        });
        
        // Seleccionar nuevo color
        this.classList.add('border-purple-500');
        this.classList.remove('border-gray-300');
        selectedBgColor = this.dataset.color;
    });
});

// Configurar el slider de tolerancia
toleranceSlider.addEventListener('input', function() {
    toleranceValue.textContent = this.value + '%';
});

// Función para calcular diferencia entre colores
function colorDistance(r1, g1, b1, r2, g2, b2) {
    return Math.sqrt(
        Math.pow(r2 - r1, 2) + 
        Math.pow(g2 - g1, 2) + 
        Math.pow(b2 - b1, 2)
    );
}

// Función para remover fondo
function removeBackground(image, targetColor, tolerance) {
    const canvas = document.getElementById('remove-bg-result');
    const ctx = canvas.getContext('2d');
    
    // Configurar canvas con las mismas dimensiones de la imagen
    canvas.width = image.width;
    canvas.height = image.height;
    
    // Dibujar imagen original
    ctx.drawImage(image, 0, 0);
    
    // Obtener datos de píxeles
    const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
    const data = imageData.data;
    
    const targetR = targetColor.r;
    const targetG = targetColor.g;
    const targetB = targetColor.b;
    
    // Máxima distancia posible entre colores
    const maxDistance = Math.sqrt(3 * Math.pow(255, 2));
    
    // Umbral basado en la tolerancia (porcentaje de la máxima distancia)
    const threshold = (tolerance / 100) * maxDistance;
    
    // Procesar cada píxel
    for (let i = 0; i < data.length; i += 4) {
        const r = data[i];
        const g = data[i + 1];
        const b = data[i + 2];
        
        // Calcular distancia al color objetivo
        const distance = colorDistance(r, g, b, targetR, targetG, targetB);
        
        // Si está dentro del umbral, hacer transparente
        if (distance <= threshold) {
            data[i + 3] = 0; // Establecer alpha a 0 (transparente)
        }
    }
    
    // Poner los datos procesados de vuelta en el canvas
    ctx.putImageData(imageData, 0, 0);
    
    return canvas;
}

// Event listener para el input de archivo
removeBgInput.addEventListener('change', async (event) => {
    const file = event.target.files[0];
    if (!file) return;
    
    // Validaciones
    if (!file.type.match('image/jpeg') && !file.type.match('image/png')) {
        showMessage('Por favor, selecciona una imagen JPG o PNG válida.');
        return;
    }
    
    if (file.size > 5 * 1024 * 1024) {
        showMessage('La imagen es demasiado grande. Máximo 5MB permitido.');
        return;
    }
    
    currentImageFile = file;
    
    // Ocultar placeholder y mostrar controles
    removeBgPlaceholder.classList.add('hidden');
    removeBgUploadSection.classList.add('hidden');
    removeBgControls.classList.remove('hidden');
    removeBgError.classList.add('hidden');
    
    // Mostrar imagen original
    const originalUrl = URL.createObjectURL(file);
    removeBgOriginal.onload = function() {
        URL.revokeObjectURL(originalUrl); // Liberar memoria
    };
    removeBgOriginal.src = originalUrl;
});

// Procesar imagen cuando se hace clic en el botón
processImageButton.addEventListener('click', function() {
    if (!currentImageFile) return;
    
    removeBgControls.classList.add('hidden');
    removeBgProcessLoader.classList.remove('hidden');
    
    // Usar setTimeout para permitir que la UI se actualice
    setTimeout(() => {
        try {
            const targetColor = colorMap[selectedBgColor];
            const tolerance = parseInt(toleranceSlider.value);
            
            // Procesar la imagen
            removeBackground(removeBgOriginal, targetColor, tolerance);
            
            // Mostrar resultado
            removeBgOutput.classList.remove('hidden');
            removeBgProcessLoader.classList.add('hidden');
            
            // Configurar descarga
            removeBgResult.toBlob(function(blob) {
                const url = URL.createObjectURL(blob);
                removeBgDownload.href = url;
                removeBgDownload.download = `${currentImageFile.name.replace(/\.[^/.]+$/, "")}_sin_fondo.png`;
            }, 'image/png');
            
        } catch (error) {
            console.error('Error al procesar la imagen:', error);
            removeBgError.classList.remove('hidden');
            removeBgErrorMessage.textContent = 'Error al procesar la imagen. Intenta con otra imagen o ajusta la precisión.';
            removeBgProcessLoader.classList.add('hidden');
            removeBgControls.classList.remove('hidden');
        }
    }, 100);
});

// Para la función showTool, actualiza la parte de remove-bg:
// if (toolId === 'remove-bg') {
//     resetRemoveBgTool();
// }
            <style>
.color-option {
    transition: all 0.2s ease;
    cursor: pointer;
}

.color-option:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
}

#remove-bg-result {
    background-image: 
        linear-gradient(45deg, #f0f0f0 25%, transparent 25%), 
        linear-gradient(-45deg, #f0f0f0 25%, transparent 25%), 
        linear-gradient(45deg, transparent 75%, #f0f0f0 75%), 
        linear-gradient(-45deg, transparent 75%, #f0f0f0 75%);
    background-size: 20px 20px;
    background-position: 0 0, 0 10px, 10px -10px, -10px 0px;
}
</style>

            // --- HERRAMIENTA 7: COMPRIMIR IMAGEN ---
            const compressInput = document.getElementById('compress-image-input');
            const compressLoader = document.getElementById('compress-loader');
            const compressOutput = document.getElementById('compress-output');
            const compressQualitySlider = document.getElementById('compress-quality');
            const compressQualityValue = document.getElementById('compress-quality-value');
            const compressOriginalImg = document.getElementById('compress-original-img');
            const compressOriginalSize = document.getElementById('compress-original-size');
            const compressResultImg = document.getElementById('compress-result-img');
            const compressResultSize = document.getElementById('compress-result-size');
            const compressDownloadLink = document.getElementById('compress-download-link');
            let originalImageFile = null;

            function formatBytes(bytes, decimals = 2) {
                if (bytes === 0) return '0 Bytes';
                const k = 1024;
                const dm = decimals < 0 ? 0 : decimals;
                const sizes = ['Bytes', 'KB', 'MB', 'GB'];
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                return parseFloat((bytes / Math.pow(k, i)).toFixed(dm)) + ' ' + sizes[i];
            }

            async function compressAndDisplayImage() {
                if (!originalImageFile) return;

                compressLoader.classList.remove('hidden');
                compressDownloadLink.classList.add('hidden');

                const quality = parseInt(compressQualitySlider.value) / 100;
                compressQualityValue.textContent = compressQualitySlider.value;
                
                const image = new Image();
                const imageURL = URL.createObjectURL(originalImageFile);
                image.src = imageURL;
                await new Promise(resolve => image.onload = resolve);
                URL.revokeObjectURL(imageURL); 

                const canvas = document.createElement('canvas');
                canvas.width = image.width;
                canvas.height = image.height;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(image, 0, 0);

                canvas.toBlob( (blob) => {
                    const compressedUrl = URL.createObjectURL(blob);
                    compressResultImg.src = compressedUrl;
                    
                    const sizeReduction = 100 - (blob.size / originalImageFile.size) * 100;
                    compressResultSize.textContent = `${formatBytes(blob.size)} (${sizeReduction.toFixed(1)}% menos)`;

                    compressDownloadLink.href = compressedUrl;
                    compressDownloadLink.download = `${originalImageFile.name.replace(/\.[^/.]+$/, "")}_comprimido.jpg`;
                    compressDownloadLink.classList.remove('hidden');
                    compressLoader.classList.add('hidden');
                }, 'image/jpeg', quality);
            }

            compressInput.addEventListener('change', async (event) => {
                const file = event.target.files[0];
                if (!file) {
                    compressOutput.classList.add('hidden');
                    return;
                }
                originalImageFile = file;

                compressOriginalImg.src = URL.createObjectURL(file);
                compressOriginalSize.textContent = `Tamaño: ${formatBytes(file.size)}`;
                compressOutput.classList.remove('hidden');
                
                await compressAndDisplayImage();
            });

            compressQualitySlider.addEventListener('input', compressAndDisplayImage);

            // --- HERRAMIENTA 8: RECORTAR AUDIO ---
            const trimAudioInput = document.getElementById('trim-audio-input');
            const trimAudioLoader = document.getElementById('trim-audio-loader');
            const trimAudioLoaderText = document.getElementById('trim-audio-loader-text');
            const trimAudioControls = document.getElementById('trim-audio-controls');
            const audioPlayer = document.getElementById('audio-player');
            const startTimeInput = document.getElementById('start-time');
            const endTimeInput = document.getElementById('end-time');
            const trimAudioButton = document.getElementById('trim-audio-button');
            const trimAudioOutput = document.getElementById('trim-audio-output');
            const trimmedAudioPlayer = document.getElementById('trimmed-audio-player');
            const downloadTrimmedAudio = document.getElementById('download-trimmed-audio');

            let audioFileBuffer = null;
            let originalAudioFileName = '';
            let trimmedWavBlob = null;
            let trimmedMp3Blob = null;
            
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();

            trimAudioInput.addEventListener('change', async (event) => {
                const file = event.target.files[0];
                if (!file) return;

                originalAudioFileName = file.name;
                trimAudioLoaderText.textContent = "Procesando archivo...";
                trimAudioLoader.classList.remove('hidden');
                trimAudioControls.classList.add('hidden');
                trimAudioOutput.classList.add('hidden');
                
                trimmedWavBlob = null;
                trimmedMp3Blob = null;

                const reader = new FileReader();
                reader.onload = async (e) => {
                    try {
                        audioFileBuffer = await audioContext.decodeAudioData(e.target.result);
                        audioPlayer.src = URL.createObjectURL(file);
                        startTimeInput.value = 0;
                        endTimeInput.value = audioFileBuffer.duration.toFixed(2);
                        startTimeInput.max = audioFileBuffer.duration.toFixed(2);
                        endTimeInput.max = audioFileBuffer.duration.toFixed(2);
                        trimAudioControls.classList.remove('hidden');
                    } catch (err) {
                        console.error("Error decodificando el audio:", err);
                        showMessage("No se pudo procesar el archivo. Asegúrate de que es un formato de audio válido.");
                    } finally {
                        trimAudioLoader.classList.add('hidden');
                    }
                };
                reader.readAsArrayBuffer(file);
            });

            trimAudioButton.addEventListener('click', async () => {
                if (!audioFileBuffer) {
                    showMessage("Por favor, sube un archivo de audio primero.");
                    return;
                }

                const startTime = parseFloat(startTimeInput.value);
                const endTime = parseFloat(endTimeInput.value);
                
                if (isNaN(startTime) || isNaN(endTime) || startTime < 0 || endTime <= startTime || endTime > audioFileBuffer.duration) {
                    showMessage("Tiempos de inicio/fin no válidos.");
                    return;
                }

                trimAudioLoaderText.textContent = "Recortando y codificando...";
                trimAudioLoader.classList.remove('hidden');
                trimAudioButton.disabled = true;
                trimAudioOutput.classList.add('hidden');

                try {
                    const startOffset = Math.floor(startTime * audioFileBuffer.sampleRate);
                    const endOffset = Math.floor(endTime * audioFileBuffer.sampleRate);
                    const frameCount = endOffset - startOffset;

                    const newBuffer = audioContext.createBuffer(
                        audioFileBuffer.numberOfChannels,
                        frameCount,
                        audioFileBuffer.sampleRate
                    );

                    for (let i = 0; i < audioFileBuffer.numberOfChannels; i++) {
                        newBuffer.getChannelData(i).set(audioFileBuffer.getChannelData(i).subarray(startOffset, endOffset));
                    }
                    
                    trimmedWavBlob = bufferToWave(newBuffer);
                    trimmedAudioPlayer.src = URL.createObjectURL(trimmedWavBlob);
                    
                    trimmedMp3Blob = null; 
                    encodeToMp3(newBuffer).then(mp3Blob => {
                        trimmedMp3Blob = mp3Blob;
                         console.log("MP3 encoding complete");
                    });

                    trimAudioOutput.classList.remove('hidden');

                } catch(err) {
                    console.error("Error al recortar el audio:", err);
                    showMessage("Ocurrió un error durante el recorte.");
                } finally {
                    trimAudioLoader.classList.add('hidden');
                    trimAudioButton.disabled = false;
                }
            });

            downloadTrimmedAudio.addEventListener('click', () => {
                const format = document.querySelector('input[name="audio-format"]:checked').value;
                const blob = (format === 'mp3') ? trimmedMp3Blob : trimmedWavBlob;
                const extension = (format === 'mp3') ? 'mp3' : 'wav';

                if (!blob) {
                    showMessage("Aún no se ha generado el archivo " + format.toUpperCase() + ". Por favor, espera un momento.");
                    return;
                }

                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.style.display = 'none';
                a.href = url;
                a.download = `${originalAudioFileName.replace(/\.[^/.]+$/, "")}_recortado.${extension}`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
            });

            function bufferToWave(abuffer) {
                const numOfChan = abuffer.numberOfChannels;
                const length = abuffer.length * numOfChan * 2 + 44;
                const buffer = new ArrayBuffer(length);
                const view = new DataView(buffer);
                let offset = 0;

                const writeString = (s) => {
                    for (let i = 0; i < s.length; i++) {
                        view.setUint8(offset + i, s.charCodeAt(i));
                    }
                    offset += s.length;
                };

                const setUint16 = (data) => {
                    view.setUint16(offset, data, true);
                    offset += 2;
                };

                const setUint32 = (data) => {
                    view.setUint32(offset, data, true);
                    offset += 4;
                };

                writeString('RIFF');
                setUint32(length - 8);
                writeString('WAVE');
                writeString('fmt ');
                setUint32(16);
                setUint16(1);
                setUint16(numOfChan);
                setUint32(abuffer.sampleRate);
                setUint32(abuffer.sampleRate * 2 * numOfChan);
                setUint16(numOfChan * 2);
                setUint16(16);
                writeString('data');
                setUint32(abuffer.length * numOfChan * 2);

                const channels = [];
                for(let i = 0; i < numOfChan; i++){
                    channels.push(abuffer.getChannelData(i));
                }

                let pos = 0;
                while(pos < abuffer.length) {
                    for(let i = 0; i < numOfChan; i++) {   
                        let sample = Math.max(-1, Math.min(1, channels[i][pos]));
                        sample = sample < 0 ? sample * 0x8000 : sample * 0x7FFF;
                        view.setInt16(offset, sample, true);
                        offset += 2;
                    }
                    pos++;
                }
                
                return new Blob([view], { type: 'audio/wav' });
            }
            
            function encodeToMp3(audioBuffer) {
                return new Promise((resolve, reject) => {
                    try {
                        if (typeof lamejs === 'undefined') {
                            return reject(new Error('LameJS no está cargado.'));
                        }
                        const channels = audioBuffer.numberOfChannels;
                        const sampleRate = audioBuffer.sampleRate;
                        const kbps = 128;
                        const mp3encoder = new lamejs.Mp3Encoder(channels, sampleRate, kbps);
                        
                        const pcmData = [];
                        for (let i = 0; i < channels; i++) {
                           const channel = audioBuffer.getChannelData(i);
                           const int16Channel = new Int16Array(channel.length);
                           for (let j = 0; j < channel.length; j++) {
                               int16Channel[j] = Math.max(-32768, Math.min(32767, channel[j] * 32767));
                           }
                           pcmData.push(int16Channel);
                        }
                        
                        const mp3Data = [];
                        const sampleBlockSize = 1152;
                        
                        for (let i = 0; i < pcmData[0].length; i += sampleBlockSize) {
                            const leftChunk = pcmData[0].subarray(i, i + sampleBlockSize);
                            let rightChunk = null;
                            if (channels > 1) {
                                rightChunk = pcmData[1].subarray(i, i + sampleBlockSize);
                            }
                            const mp3buf = mp3encoder.encodeBuffer(leftChunk, rightChunk);
                            if (mp3buf.length > 0) {
                                mp3Data.push(mp3buf);
                            }
                        }
                        
                        const mp3buf = mp3encoder.flush();
                        if (mp3buf.length > 0) {
                            mp3Data.push(mp3buf);
                        }
                        
                        const blob = new Blob(mp3Data, {type: 'audio/mpeg'});
                        resolve(blob);
                    } catch (e) {
                        reject(e);
                    }
                });
            }

            // --- HERRAMIENTA 9: FIRMAR PDF ---
            const signPdfInput = document.getElementById('sign-pdf-input');
            const signStep1 = document.getElementById('sign-step-1');
            const signStep2 = document.getElementById('sign-step-2');
            const signStep3 = document.getElementById('sign-step-3');
            const signPdfFilename = document.getElementById('sign-pdf-filename');
            const signPdfLoader = document.getElementById('sign-pdf-loader');
            const signPdfLoaderText = document.getElementById('sign-pdf-loader-text');
            const pdfPagesContainer = document.getElementById('pdf-pages-container');
            const applySignatureButton = document.getElementById('apply-signature-button');
            const redrawSignatureButton = document.getElementById('redraw-signature-button');

            const signatureCanvas = document.getElementById('signature-canvas');
            const signatureCtx = signatureCanvas.getContext('2d');
            const clearSignatureButton = document.getElementById('clear-signature-button');
            const saveSignatureButton = document.getElementById('save-signature-button');
            
            let isDrawing = false;
            let lastX = 0;
            let lastY = 0;
            let signatureDataUrl = null;
            let originalPdfBytes = null;
            let signOriginalPdfName = '';
            
            let activeSignature = {
                element: null,
                isDragging: false,
                isResizing: false,
                offsetX: 0,
                offsetY: 0
            };

            function setupSignatureCanvas() {
                const ratio = Math.max(window.devicePixelRatio || 1, 1);
                const canvas = signatureCanvas;
                const parentWidth = canvas.parentElement.offsetWidth;
                canvas.style.width = '100%';
                canvas.style.height = `${parentWidth / 2}px`;
                canvas.width = canvas.offsetWidth * ratio;
                canvas.height = canvas.offsetHeight * ratio;
                canvas.getContext("2d").scale(ratio, ratio);
                signatureCtx.clearRect(0, 0, canvas.width, canvas.height); 
            }
            
            function resetSignPdfTool() {
                signPdfInput.value = '';
                signPdfFilename.textContent = '';
                pdfPagesContainer.innerHTML = '';
                originalPdfBytes = null;
                signOriginalPdfName = '';
                signStep1.classList.remove('hidden');
                signStep2.classList.add('hidden');
                signStep3.classList.add('hidden');
                if(activeSignature.element) {
                    activeSignature.element.remove();
                    activeSignature.element = null;
                }
                signatureCtx.clearRect(0, 0, signatureCanvas.width, signatureCanvas.height);
            }
            
            function getEventPos(canvas, evt) {
                const rect = canvas.getBoundingClientRect();
                const clientX = evt.clientX || (evt.touches && evt.touches[0] ? evt.touches[0].clientX : 0);
                const clientY = evt.clientY || (evt.touches && evt.touches[0] ? evt.touches[0].clientY : 0);
                return {
                    x: clientX - rect.left,
                    y: clientY - rect.top
                };
            }

            function startDrawing(e) {
                isDrawing = true;
                const pos = getEventPos(signatureCanvas, e);
                [lastX, lastY] = [pos.x, pos.y];
            }

            function draw(e) {
                if (!isDrawing) return;
                e.preventDefault();
                const pos = getEventPos(signatureCanvas, e);
                signatureCtx.strokeStyle = '#000';
                signatureCtx.lineWidth = 2;
                signatureCtx.lineCap = 'round';
                signatureCtx.beginPath();
                signatureCtx.moveTo(lastX, lastY);
                signatureCtx.lineTo(pos.x, pos.y);
                signatureCtx.stroke();
                [lastX, lastY] = [pos.x, pos.y];
            }
            
            function stopDrawing() {
                isDrawing = false;
            }

            signatureCanvas.addEventListener('mousedown', startDrawing);
            signatureCanvas.addEventListener('mousemove', draw);
            signatureCanvas.addEventListener('mouseup', stopDrawing);
            signatureCanvas.addEventListener('mouseleave', stopDrawing);
            
            signatureCanvas.addEventListener('touchstart', (e) => { e.preventDefault(); startDrawing(e); });
            signatureCanvas.addEventListener('touchmove', (e) => { e.preventDefault(); draw(e); });
            signatureCanvas.addEventListener('touchend', stopDrawing);

            clearSignatureButton.addEventListener('click', () => {
                signatureCtx.clearRect(0, 0, signatureCanvas.width, signatureCanvas.height);
            });

            async function renderPdfPagesForSigning() {
                if (!originalPdfBytes) return;

                pdfPagesContainer.innerHTML = '';
                signPdfLoaderText.textContent = 'Cargando previsualización del PDF...';
                signPdfLoader.classList.remove('hidden');

                try {
                    const typedarray = new Uint8Array(originalPdfBytes);
                    const pdf = await pdfjsLib.getDocument(typedarray).promise;

                    for (let i = 1; i <= pdf.numPages; i++) {
                        const page = await pdf.getPage(i);
                        const viewport = page.getViewport({ scale: 1 });
                        const canvas = document.createElement('canvas');
                        canvas.className = 'pdf-page-canvas shadow-lg';
                        const context = canvas.getContext('2d');
                        
                        const containerWidth = pdfPagesContainer.clientWidth > 0 ? pdfPagesContainer.clientWidth : 800;
                        const scale = (containerWidth - 32) / viewport.width; 
                        const scaledViewport = page.getViewport({ scale: scale });
                        
                        canvas.height = scaledViewport.height;
                        canvas.width = scaledViewport.width;
                        canvas.dataset.pageNumber = i;

                        await page.render({ canvasContext: context, viewport: scaledViewport }).promise;
                        
                        canvas.addEventListener('click', (e) => {
                            const rect = canvas.getBoundingClientRect();
                            const x = e.clientX - rect.left;
                            const y = e.clientY - rect.top;
                            placeSignature(x, y, canvas);
                        });

                        pdfPagesContainer.appendChild(canvas);
                    }
                } catch(e) {
                    showMessage("Error al renderizar el PDF.");
                    console.error(e);
                } finally {
                    signPdfLoader.classList.add('hidden');
                }
            }
            
            saveSignatureButton.addEventListener('click', async () => {
                const isEmpty = !signatureCtx.getImageData(0,0,signatureCanvas.width, signatureCanvas.height).data.some(channel => channel !== 0);
                if (isEmpty) {
                    showMessage("Por favor, dibuja una firma antes de guardar.");
                    return;
                }
                signatureDataUrl = signatureCanvas.toDataURL('image/png');
                sessionStorage.setItem('rrtools_signature', signatureDataUrl); // Guardar en la sesión
                signStep2.classList.add('hidden');
                signStep3.classList.remove('hidden');
                await renderPdfPagesForSigning();
            });
            
            signPdfInput.addEventListener('change', async (event) => {
                const file = event.target.files[0];
                if (!file) return;
                
                resetSignPdfTool();
                signOriginalPdfName = file.name;
                signPdfFilename.textContent = `Archivo: ${file.name}`;
                
                const savedSignature = sessionStorage.getItem('rrtools_signature');
                if (savedSignature) {
                    signatureDataUrl = savedSignature;
                }

                try {
                    const fileReader = new FileReader();
                    fileReader.readAsArrayBuffer(file);
                    fileReader.onload = async (e) => {
                        originalPdfBytes = e.target.result;
                        signStep1.classList.add('hidden');

                        if (signatureDataUrl) {
                            signStep3.classList.remove('hidden');
                            await renderPdfPagesForSigning();
                        } else {
                            signStep2.classList.remove('hidden');
                            setTimeout(setupSignatureCanvas, 50); 
                        }
                    };
                } catch(e) {
                    showMessage("Error al cargar el archivo PDF.");
                    console.error(e);
                    resetSignPdfTool();
                }
            });

            redrawSignatureButton.addEventListener('click', () => {
                signStep3.classList.add('hidden');
                signStep2.classList.remove('hidden');
                if (activeSignature.element) {
                    activeSignature.element.remove();
                    activeSignature.element = null;
                }
                signatureDataUrl = null;
                sessionStorage.removeItem('rrtools_signature');
                setTimeout(setupSignatureCanvas, 50);
            });

            function placeSignature(clickX, clickY, targetCanvas) {
                if (!signatureDataUrl) {
                    showMessage("Error: No se ha encontrado la firma. Por favor, dibújala de nuevo.");
                    redrawSignatureButton.click();
                    return;
                }

                if (activeSignature.element) {
                    activeSignature.element.remove();
                }
                
                const signatureContainer = document.createElement('div');
                signatureContainer.id = 'draggable-signature';
                signatureContainer.style.width = '150px'; 
                signatureContainer.style.height = '75px';

                const signatureImg = document.createElement('img');
                signatureImg.src = signatureDataUrl;
                
                const resizeHandle = document.createElement('div');
                resizeHandle.id = 'resize-handle';
                
                signatureContainer.appendChild(signatureImg);
                signatureContainer.appendChild(resizeHandle);
                
                pdfPagesContainer.appendChild(signatureContainer);

                activeSignature.element = signatureContainer;
                activeSignature.page = targetCanvas;

                signatureContainer.style.left = `${targetCanvas.offsetLeft + clickX - (signatureContainer.offsetWidth / 2)}px`;
                signatureContainer.style.top = `${targetCanvas.offsetTop + clickY - (signatureContainer.offsetHeight / 2)}px`;

                let initialMouseX, initialMouseY, initialWidth, initialHeight, initialLeft, initialTop;
                
                const dragStart = (e) => {
                    e.preventDefault();
                    if (e.target.id === 'resize-handle') return;
                    activeSignature.isDragging = true;
                    const clientX = e.clientX || e.touches[0].clientX;
                    const clientY = e.clientY || e.touches[0].clientY;
                    initialMouseX = clientX;
                    initialMouseY = clientY;
                    initialLeft = signatureContainer.offsetLeft;
                    initialTop = signatureContainer.offsetTop;
                    document.addEventListener('mousemove', dragMove);
                    document.addEventListener('touchmove', dragMove, { passive: false });
                    document.addEventListener('mouseup', dragEnd);
                    document.addEventListener('touchend', dragEnd);
                };

                const resizeStart = (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    activeSignature.isResizing = true;
                    const clientX = e.clientX || e.touches[0].clientX;
                    initialMouseX = clientX;
                    initialWidth = signatureContainer.offsetWidth;
                    document.addEventListener('mousemove', resizeMove);
                    document.addEventListener('touchmove', resizeMove, { passive: false });
                    document.addEventListener('mouseup', resizeEnd);
                    document.addEventListener('touchend', resizeEnd);
                };

                const dragMove = (e) => {
                    if (activeSignature.isDragging) {
                        e.preventDefault();
                        const clientX = e.clientX || e.touches[0].clientX;
                        const clientY = e.clientY || e.touches[0].clientY;
                        const dx = clientX - initialMouseX;
                        const dy = clientY - initialMouseY;
                        signatureContainer.style.left = `${initialLeft + dx}px`;
                        signatureContainer.style.top = `${initialTop + dy}px`;
                    }
                };

                const resizeMove = (e) => {
                    if (activeSignature.isResizing) {
                        e.preventDefault();
                        const clientX = e.clientX || e.touches[0].clientX;
                        const dw = clientX - initialMouseX;
                        const newWidth = initialWidth + dw;
                        signatureContainer.style.width = `${Math.max(50, newWidth)}px`; 
                        signatureContainer.style.height = `${Math.max(25, newWidth / 2)}px`;
                    }
                };
                
                const dragEnd = () => {
                    activeSignature.isDragging = false;
                    document.removeEventListener('mousemove', dragMove);
                    document.removeEventListener('touchmove', dragMove);
                    document.removeEventListener('mouseup', dragEnd);
                    document.removeEventListener('touchend', dragEnd);
                };

                 const resizeEnd = () => {
                    activeSignature.isResizing = false;
                    document.removeEventListener('mousemove', resizeMove);
                    document.removeEventListener('touchmove', resizeMove);
                    document.removeEventListener('mouseup', resizeEnd);
                    document.removeEventListener('touchend', resizeEnd);
                };

                signatureContainer.addEventListener('mousedown', dragStart);
                signatureContainer.addEventListener('touchstart', dragStart, { passive: false });
                resizeHandle.addEventListener('mousedown', resizeStart);
                resizeHandle.addEventListener('touchstart', resizeStart, { passive: false });

                applySignatureButton.classList.remove('hidden');
            }
            
            applySignatureButton.addEventListener('click', async () => {
                if (!activeSignature.element || !activeSignature.page) {
                    showMessage("Por favor, coloca la firma en el documento primero.");
                    return;
                }

                signPdfLoaderText.textContent = 'Aplicando firma y generando PDF...';
                signPdfLoader.classList.remove('hidden');
                applySignatureButton.disabled = true;

                try {
                    const targetCanvas = activeSignature.page;
                    const targetPageNum = parseInt(targetCanvas.dataset.pageNumber) - 1;
                    
                    const pdfDoc = await PDFDocument.load(originalPdfBytes);
                    const pdfPage = pdfDoc.getPages()[targetPageNum];
                    const signatureImage = await pdfDoc.embedPng(signatureDataUrl);

                    const { width: pageWidth, height: pageHeight } = pdfPage.getSize();
                    const scale = pageWidth / targetCanvas.width;
                    
                    const sigFinalX = (activeSignature.element.offsetLeft - targetCanvas.offsetLeft) * scale;
                    const sigFinalY = pageHeight - ((activeSignature.element.offsetTop - targetCanvas.offsetTop) * scale) - (activeSignature.element.offsetHeight * scale);
                    const sigFinalWidth = activeSignature.element.offsetWidth * scale;
                    const sigFinalHeight = activeSignature.element.offsetHeight * scale;

                    pdfPage.drawImage(signatureImage, {
                        x: sigFinalX,
                        y: sigFinalY,
                        width: sigFinalWidth,
                        height: sigFinalHeight,
                    });

                    const pdfBytes = await pdfDoc.save();
                    const blob = new Blob([pdfBytes], { type: 'application/pdf' });
                    const link = document.createElement('a');
                    link.href = URL.createObjectURL(blob);
                    link.download = `${signOriginalPdfName.replace(/\.[^/.]+$/, "")}_firmado.pdf`;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    URL.revokeObjectURL(link.href);
                    
                    showMessage("¡PDF firmado y descargado con éxito!");
                    resetSignPdfTool();

                } catch (err) {
                    console.error("Error al aplicar la firma:", err);
                    showMessage("Ocurrió un error al aplicar la firma.");
                } finally {
                    signPdfLoader.classList.add('hidden');
                    applySignatureButton.disabled = false;
                }
            });
        });
    </script>
</body>
</html>

